<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSH 文件管理器 - 重复文件检测与删除</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .file-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .file-item:hover {
            background-color: #f8f9fa;
        }
        .loading {
            display: none;
        }
        .duplicate-item {
            border-left: 4px solid #dc3545;
        }
        .similar-item {
            border-left: 4px solid #ffc107;
        }
        .batch-controls {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .path-input {
            font-family: 'Courier New', monospace;
        }
        .main-container {
            margin-top: 20px;
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            border: none;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .btn-success {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            border: none;
        }
    </style>
</head>
<body class="bg-light">
    <!-- 连接状态指示器 -->
    <div class="connection-status">
        <span id="connectionBadge" class="badge bg-danger">
            <i class="bi bi-wifi-off"></i> 未连接
        </span>
    </div>

    <div class="container main-container">
        <div class="row">
            <div class="col-12">
                <div class="text-center mb-4">
                    <h1 class="display-4 text-primary">
                        <i class="bi bi-server"></i> SSH 文件管理器
                    </h1>
                    <p class="lead text-muted">远程重复文件检测与删除工具</p>
                </div>
            </div>
        </div>

        <!-- SSH 连接面板 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-plug"></i> SSH 服务器连接
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="connectionForm">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="hostname" class="form-label">服务器地址</label>
                                        <input type="text" class="form-control" id="hostname" placeholder="192.168.1.100" required>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="username" class="form-label">用户名</label>
                                        <input type="text" class="form-control" id="username" placeholder="root" required>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="password" class="form-label">密码</label>
                                        <input type="password" class="form-control" id="password" required>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="mb-3">
                                        <label for="port" class="form-label">端口</label>
                                        <input type="number" class="form-control" id="port" value="22">
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    <div class="mb-3">
                                        <label class="form-label">&nbsp;</label>
                                        <div>
                                            <button type="button" id="connectBtn" class="btn btn-primary w-100">
                                                <i class="bi bi-plug"></i> 连接
                                            </button>
                                            <button type="button" id="disconnectBtn" class="btn btn-danger w-100" style="display:none;">
                                                <i class="bi bi-plug-fill"></i> 断开
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 路径比较面板 -->
        <div class="row mb-4" id="comparePanel" style="display:none;">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-search"></i> 目录比较
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="path1" class="form-label">路径 1</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control path-input" id="path1" placeholder="/home/user/folder1">
                                        <button class="btn btn-outline-secondary" type="button" onclick="browsePath('path1')">
                                            <i class="bi bi-folder"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="path2" class="form-label">路径 2</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control path-input" id="path2" placeholder="/home/user/folder2">
                                        <button class="btn btn-outline-secondary" type="button" onclick="browsePath('path2')">
                                            <i class="bi bi-folder"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label for="similarityThreshold" class="form-label">相似度阈值</label>
                                    <select class="form-control" id="similarityThreshold">
                                        <option value="0.6">60%</option>
                                        <option value="0.7">70%</option>
                                        <option value="0.8" selected>80%</option>
                                        <option value="0.9">90%</option>
                                        <option value="1.0">完全匹配</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label class="form-label">&nbsp;</label>
                                    <div>
                                        <button type="button" id="compareBtn" class="btn btn-success w-100">
                                            <i class="bi bi-search"></i> 比较
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 结果显示面板 -->
        <div class="row" id="resultsPanel" style="display:none;">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-files"></i> 重复文件列表
                        </h5>
                        <span id="duplicateCount" class="badge bg-light text-dark"></span>
                    </div>
                    <div class="card-body">
                        <!-- 批量操作控制区 -->
                        <div class="batch-controls" id="batchControls" style="display:none;">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="selectAll">
                                        <label class="form-check-label" for="selectAll">
                                            <strong>全选/全不选</strong>
                                        </label>
                                    </div>
                                    <small class="text-muted">已选择: <span id="selectedCount">0</span> 个项目</small>
                                </div>
                                <div class="col-md-6 text-end">
                                    <button type="button" class="btn btn-warning me-2" onclick="batchDeletePath1()">
                                        <i class="bi bi-trash"></i> 批量删除路径1
                                    </button>
                                    <button type="button" class="btn btn-danger" onclick="batchDeletePath2()">
                                        <i class="bi bi-trash"></i> 批量删除路径2
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="duplicatesList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 目录浏览模态框 -->
    <div class="modal fade" id="browseModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-folder-open"></i> 选择目录
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb" id="pathBreadcrumb"></ol>
                    </nav>
                    <div id="fileList" class="list-group"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="selectPathBtn">选择此路径</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 加载提示 -->
    <div class="position-fixed top-50 start-50 translate-middle loading" id="loadingSpinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">加载中...</span>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentBrowsingInput = '';
        let currentPath = '/';
        let browseModal;

        document.addEventListener('DOMContentLoaded', function() {
            browseModal = new bootstrap.Modal(document.getElementById('browseModal'));
            
            // 连接按钮事件
            document.getElementById('connectBtn').addEventListener('click', connectSSH);
            document.getElementById('disconnectBtn').addEventListener('click', disconnectSSH);
            document.getElementById('compareBtn').addEventListener('click', comparePaths);
            document.getElementById('selectPathBtn').addEventListener('click', selectCurrentPath);
            
            // 检查连接状态
            updateConnectionStatus({{ 'true' if connected else 'false' }});
        });

        function showLoading() {
            document.getElementById('loadingSpinner').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loadingSpinner').style.display = 'none';
        }

        function showMessage(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        function updateConnectionStatus(connected) {
            const badge = document.getElementById('connectionBadge');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const comparePanel = document.getElementById('comparePanel');
            
            if (connected) {
                badge.className = 'badge bg-success';
                badge.innerHTML = '<i class="bi bi-wifi"></i> 已连接';
                connectBtn.style.display = 'none';
                disconnectBtn.style.display = 'block';
                comparePanel.style.display = 'block';
            } else {
                badge.className = 'badge bg-danger';
                badge.innerHTML = '<i class="bi bi-wifi-off"></i> 未连接';
                connectBtn.style.display = 'block';
                disconnectBtn.style.display = 'none';
                comparePanel.style.display = 'none';
                document.getElementById('resultsPanel').style.display = 'none';
            }
        }

        async function connectSSH() {
            const hostname = document.getElementById('hostname').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const port = document.getElementById('port').value;

            if (!hostname || !username || !password) {
                showMessage('请填写完整的连接信息', 'warning');
                return;
            }

            showLoading();
            try {
                const response = await fetch('/connect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        hostname: hostname,
                        username: username,
                        password: password,
                        port: port
                    })
                });

                const result = await response.json();
                hideLoading();

                if (result.success) {
                    updateConnectionStatus(true);
                    showMessage(result.message, 'success');
                } else {
                    showMessage(result.message, 'danger');
                }
            } catch (error) {
                hideLoading();
                showMessage('连接请求失败: ' + error.message, 'danger');
            }
        }

        async function disconnectSSH() {
            try {
                const response = await fetch('/disconnect', {
                    method: 'POST'
                });
                const result = await response.json();
                updateConnectionStatus(false);
                showMessage(result.message, 'info');
            } catch (error) {
                showMessage('断开连接失败: ' + error.message, 'danger');
            }
        }

        async function comparePaths() {
            const path1 = document.getElementById('path1').value;
            const path2 = document.getElementById('path2').value;
            const similarityThreshold = parseFloat(document.getElementById('similarityThreshold').value);

            if (!path1 || !path2) {
                showMessage('请输入两个有效的路径', 'warning');
                return;
            }

            showLoading();
            try {
                const response = await fetch('/compare', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        path1: path1,
                        path2: path2,
                        similarity_threshold: similarityThreshold
                    })
                });

                const result = await response.json();
                hideLoading();

                if (result.success) {
                    displayDuplicates(result.duplicates);
                    showMessage(result.message, 'success');
                } else {
                    showMessage(result.message, 'danger');
                }
            } catch (error) {
                hideLoading();
                showMessage('比较请求失败: ' + error.message, 'danger');
            }
        }

        let duplicatesData = [];
        
        function displayDuplicates(duplicates) {
            duplicatesData = duplicates; // 保存数据供批量操作使用
            const resultsPanel = document.getElementById('resultsPanel');
            const duplicatesList = document.getElementById('duplicatesList');
            const duplicateCount = document.getElementById('duplicateCount');
            const batchControls = document.getElementById('batchControls');

            const exactCount = duplicates.filter(d => d.match_type === 'exact').length;
            const similarCount = duplicates.filter(d => d.match_type === 'similar').length;
            duplicateCount.textContent = `找到 ${exactCount} 个完全重复项和 ${similarCount} 个相似项`;

            if (duplicates.length === 0) {
                duplicatesList.innerHTML = '<div class="alert alert-info">没有找到重复的文件或文件夹</div>';
                batchControls.style.display = 'none';
            } else {
                let html = '';
                duplicates.forEach((item, index) => {
                    const itemClass = item.match_type === 'exact' ? 'duplicate-item' : 'similar-item';
                    const similarityBadge = item.match_type === 'similar' ? 
                        `<span class="badge bg-warning text-dark ms-2">相似度: ${Math.round(item.similarity * 100)}%</span>` : '';
                    
                    html += `
                        <div class="card mb-3 ${itemClass}">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-1">
                                        <input type="checkbox" class="form-check-input item-checkbox" 
                                               data-index="${index}" onchange="updateSelectedCount()">
                                    </div>
                                    <div class="col-md-5">
                                        <h6 class="card-title">
                                            <i class="bi bi-${item.type === 'file' ? 'file-earmark' : 'folder'}"></i>
                                            ${item.name}
                                            ${similarityBadge}
                                        </h6>
                                        <small class="text-muted">类型: ${item.type === 'file' ? '文件' : '目录'}</small>
                                        ${item.type === 'file' && typeof item.size === 'number' ? '<br><small class="text-muted">大小: ' + formatFileSize(item.size) + '</small>' : ''}
                                        ${item.type === 'file' && typeof item.size === 'string' ? '<br><small class="text-muted">大小: ' + item.size + '</small>' : ''}
                                    </div>
                                    <div class="col-md-6">
                                        <div class="row">
                                            <div class="col-6">
                                                <div class="card bg-light">
                                                    <div class="card-body p-2">
                                                        <small class="text-muted d-block">路径 1:</small>
                                                        <code class="small">${item.path1}</code>
                                                        <br><small class="text-muted">修改时间: ${item.modified1}</small>
                                                        <br>
                                                        <button class="btn btn-danger btn-sm mt-2" onclick="deleteFile('${item.path1}', ${index})">
                                                            <i class="bi bi-trash"></i> 删除
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="card bg-light">
                                                    <div class="card-body p-2">
                                                        <small class="text-muted d-block">路径 2:</small>
                                                        <code class="small">${item.path2}</code>
                                                        <br><small class="text-muted">修改时间: ${item.modified2}</small>
                                                        <br>
                                                        <button class="btn btn-danger btn-sm mt-2" onclick="deleteFile('${item.path2}', ${index})">
                                                            <i class="bi bi-trash"></i> 删除
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                duplicatesList.innerHTML = html;
                batchControls.style.display = 'block';
                
                // 设置全选/全不选事件
                document.getElementById('selectAll').onchange = function() {
                    const checkboxes = document.querySelectorAll('.item-checkbox');
                    checkboxes.forEach(cb => cb.checked = this.checked);
                    updateSelectedCount();
                };
            }

            resultsPanel.style.display = 'block';
        }

        async function deleteFile(path, index) {
            if (!confirm(`确定要删除 ${path} 吗？此操作不可撤销！`)) {
                return;
            }

            showLoading();
            try {
                const response = await fetch('/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        path: path
                    })
                });

                const result = await response.json();
                hideLoading();

                if (result.success) {
                    showMessage(result.message, 'success');
                    // 重新比较以更新列表
                    comparePaths();
                } else {
                    showMessage(result.message, 'danger');
                }
            } catch (error) {
                hideLoading();
                showMessage('删除请求失败: ' + error.message, 'danger');
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function browsePath(inputId) {
            // 先检查连接状态
            try {
                const statusResponse = await fetch('/connection_status');
                const statusResult = await statusResponse.json();
                
                if (!statusResult.connected) {
                    showMessage('请先连接SSH服务器', 'warning');
                    updateConnectionStatus(false);
                    return;
                }
            } catch (error) {
                showMessage('检查连接状态失败', 'danger');
                return;
            }
            
            currentBrowsingInput = inputId;
            currentPath = document.getElementById(inputId).value || '/';
            loadDirectory(currentPath);
            browseModal.show();
        }

        async function loadDirectory(path) {
            try {
                const response = await fetch(`/browse?path=${encodeURIComponent(path)}`);
                const result = await response.json();

                if (result.success) {
                    displayFileList(result.items, result.current_path);
                    updateBreadcrumb(result.current_path);
                } else {
                    showMessage(result.message, 'danger');
                    // 如果是连接问题，更新连接状态
                    if (result.message.includes('请先连接SSH服务器')) {
                        updateConnectionStatus(false);
                        browseModal.hide();
                    }
                }
            } catch (error) {
                showMessage('浏览目录失败: ' + error.message, 'danger');
            }
        }

        function displayFileList(items, path) {
            const fileList = document.getElementById('fileList');
            currentPath = path;
            
            let html = '';
            
            // 添加上级目录选项
            if (path !== '/') {
                html += `
                    <div class="list-group-item file-item" onclick="navigateToParent()">
                        <i class="bi bi-arrow-up"></i> 上级目录
                    </div>
                `;
            }
            
            // 先显示目录
            items.filter(item => item.is_dir).forEach(item => {
                html += `
                    <div class="list-group-item file-item" onclick="loadDirectory('${item.path}')">
                        <i class="bi bi-folder text-warning"></i> ${item.name}
                        <small class="text-muted float-end">${item.modified}</small>
                    </div>
                `;
            });
            
            // 再显示文件
            items.filter(item => !item.is_dir).forEach(item => {
                html += `
                    <div class="list-group-item">
                        <i class="bi bi-file-earmark text-primary"></i> ${item.name}
                        <small class="text-muted float-end">${formatFileSize(item.size)} | ${item.modified}</small>
                    </div>
                `;
            });
            
            if (html === '') {
                html = '<div class="list-group-item text-muted">目录为空</div>';
            }
            
            fileList.innerHTML = html;
        }

        function updateBreadcrumb(path) {
            const breadcrumb = document.getElementById('pathBreadcrumb');
            const parts = path.split('/').filter(part => part !== '');
            
            let html = '<li class="breadcrumb-item"><a href="#" onclick="loadDirectory(\'/\')">根目录</a></li>';
            let currentPath = '';
            
            parts.forEach((part, index) => {
                currentPath += '/' + part;
                if (index === parts.length - 1) {
                    html += `<li class="breadcrumb-item active">${part}</li>`;
                } else {
                    html += `<li class="breadcrumb-item"><a href="#" onclick="loadDirectory('${currentPath}')">${part}</a></li>`;
                }
            });
            
            breadcrumb.innerHTML = html;
        }

        function navigateToParent() {
            const parentPath = currentPath.substring(0, currentPath.lastIndexOf('/')) || '/';
            loadDirectory(parentPath);
        }

        function selectCurrentPath() {
            document.getElementById(currentBrowsingInput).value = currentPath;
            browseModal.hide();
        }

        function updateSelectedCount() {
            const checked = document.querySelectorAll('.item-checkbox:checked').length;
            document.getElementById('selectedCount').textContent = checked;
        }

        function getSelectedPaths(pathType) {
            const checkedBoxes = document.querySelectorAll('.item-checkbox:checked');
            const paths = [];
            checkedBoxes.forEach(checkbox => {
                const index = parseInt(checkbox.dataset.index);
                const item = duplicatesData[index];
                if (pathType === 'path1') {
                    paths.push(item.path1);
                } else {
                    paths.push(item.path2);
                }
            });
            return paths;
        }

        async function batchDeletePath1() {
            const paths = getSelectedPaths('path1');
            if (paths.length === 0) {
                showMessage('请先选择要删除的项目', 'warning');
                return;
            }
            
            const confirmMessage = `确定要删除路径1中的 ${paths.length} 个项目吗？\n\n${paths.slice(0, 5).join('\n')}${paths.length > 5 ? '\n...' : ''}\n\n此操作不可撤销！`;
            if (!confirm(confirmMessage)) {
                return;
            }

            await performBatchDelete(paths);
        }

        async function batchDeletePath2() {
            const paths = getSelectedPaths('path2');
            if (paths.length === 0) {
                showMessage('请先选择要删除的项目', 'warning');
                return;
            }
            
            const confirmMessage = `确定要删除路径2中的 ${paths.length} 个项目吗？\n\n${paths.slice(0, 5).join('\n')}${paths.length > 5 ? '\n...' : ''}\n\n此操作不可撤销！`;
            if (!confirm(confirmMessage)) {
                return;
            }

            await performBatchDelete(paths);
        }

        async function performBatchDelete(paths) {
            showLoading();
            try {
                const response = await fetch('/batch_delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        paths: paths
                    })
                });

                const result = await response.json();
                hideLoading();

                if (result.success) {
                    showMessage(result.message, 'success');
                    
                    // 显示详细结果
                    let detailMessage = `删除结果详情:\n`;
                    result.results.forEach(r => {
                        detailMessage += `${r.success ? '✅' : '❌'} ${r.path}: ${r.message}\n`;
                    });
                    
                    if (result.summary.failed > 0) {
                        console.log('批量删除详细结果:', detailMessage);
                    }
                    
                    // 重新比较以更新列表
                    comparePaths();
                } else {
                    showMessage(result.message, 'danger');
                }
            } catch (error) {
                hideLoading();
                showMessage('批量删除请求失败: ' + error.message, 'danger');
            }
        }
    </script>
</body>
</html> 